name: "MNCD"

trigger:
  - master

pool:
  vmImage: "ubuntu-latest"

variables:
  buildConfiguration: "Release"

stages:
- stage: build
  displayName: Build
  jobs:
    - job: build 
      displayName: Build
      steps:
          - task: DotNetCoreCLI@2
            displayName: "dotnet build $(buildConfiguration)"
            inputs:
              command: "build"
              arguments: --configuration $(buildConfiguration)
              workingDirectory: src
              
- stage: test
  displayName: Test
  dependsOn: build
  jobs:
    - job: test
      displayName: Test
      steps:
          - task: DotNetCoreCLI@2
            displayName: "dotnet test"
            inputs:
              command: "test"
              workingDirectory: src

- stage: pack
  displayName: Pack & Publish Nuget
  dependsOn: test
  jobs:
    - job: pack
      displayName: Pack
      steps:
          - task: DotNetCoreCLI@2
            displayName: "dotnet pack"
            inputs:
              command: "pack"
              arguments: "--configuration $(buildConfiguration)"
              packagesToPack: "src/MNCD/MNCD.csproj"
              nobuild: true
              versioningScheme: "off"

- stage: publish
  displayName: Publish Nuget
  dependsOn: pack
  jobs:
    - job: publish
      displayName: Publish
      steps:
          - task: NuGetCommand@2
            displayName: "nuget push"
            inputs:
              command: "push"
              feedsToUse: "select"
              packagesToPush: "$(Build.ArtifactStagingDirectory)/**/*.nupkg;!$(Build.ArtifactStagingDirectory)/**/*.symbols.nupkg"
              nuGetFeedType: "internal"
              publishVstsFeed: "MNCD"
              versioningScheme: "off"
              allowPackageConflicts: true
