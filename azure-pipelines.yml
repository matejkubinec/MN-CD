name: "MNCD"

trigger:
  - master

pool:
  vmImage: "ubuntu-latest"

variables:
  buildConfiguration: "Release"

stages:
- stage: build_and_test
  displayName: Build & Test
  jobs:
    - job: build 
      displayName: Build
      steps:
          - task: DotNetCoreCLI@2
            displayName: "dotnet build $(buildConfiguration)"
            inputs:
              command: "build"
              arguments: --configuration $(buildConfiguration)
              workingDirectory: src
    - job: test
      displayName: Test
      steps:
          - task: DotNetCoreCLI@2
            displayName: "dotnet test"
            inputs:
              command: "test"
              workingDirectory: src

- stage: pack_and_publish
  displayName: Pack & Publish Nuget
  jobs:
    - job: pack
      displayName: Pack
      steps:
          - task: DotNetCoreCLI@2
            displayName: "dotnet pack"
            inputs:
              command: "pack"
              arguments: "--configuration $(buildConfiguration)"
              packagesToPack: "src/MNCD/MNCD.csproj"
              nobuild: true
              versioningScheme: "off"
    - job: publish
      displayName: Publish
      steps:
          - task: NuGetCommand@2
            displayName: "nuget push"
            inputs:
              command: "push"
              feedsToUse: "select"
              packagesToPush: "$(Build.ArtifactStagingDirectory)/**/*.nupkg;!$(Build.ArtifactStagingDirectory)/**/*.symbols.nupkg"
              nuGetFeedType: "internal"
              publishVstsFeed: "MNCD"
              versioningScheme: "off"
              allowPackageConflicts: true
